<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: 100dvh;
            background: #fefefe;
            font-family: 'Poppins', sans-serif;
            color: #1a1a1a;
            padding: 20px;
            padding-bottom: env(safe-area-inset-bottom, 20px);
            overflow: auto;
        }

        #game-container {
            text-align: center;
            max-width: 500px;
            width: 100%;
            max-height: calc(100vh - 40px);
            max-height: calc(100dvh - 40px);
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 20px;
            padding-bottom: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }

        header {
            margin-bottom: 15px;
            position: relative;
        }

        h1 {
            font-size: 38px;
            font-weight: 900;
            letter-spacing: 0.1em;
            margin-bottom: 5px;
            background: linear-gradient(to right, #1a1a1a, #666);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .help-btn {
            position: absolute;
            top: 0;
            right: 0;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            background: white;
            color: #666;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            border-color: #0ea5e9;
            color: #0ea5e9;
            transform: scale(1.1);
        }

        #subtitle {
            color: #666;
            font-size: 12px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        #mode-toggle {
            display: inline-flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .mode-btn {
            padding: 6px 10px;
            border: none;
            background: #f0f0f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            color: #666;
            position: relative;
            width: 60px;
            line-height: 1.4;
        }

        .mode-btn.completed::after {
            content: '✓';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #4ade80;
            color: #000;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mode-btn.failed::after {
            content: '✗';
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .mode-btn.active {
            background: #0ea5e9;
            color: #fff;
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
            font-weight: 600;
        }

        #stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 15px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        .stat {
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 16px;
        }

        #strikes-display {
            display: inline-flex;
            gap: 8px;
        }

        .strike {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .strike.filled {
            background: #ef4444;
            color: white;
            animation: strikeAnimation 0.3s ease-out;
        }

        .strike.success {
            background: #4ade80;
            color: #000;
            animation: strikeAnimation 0.3s ease-out;
        }

        @keyframes strikeAnimation {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        #game-area {
            position: relative;
            margin-bottom: 20px;
            text-align: center;
        }

        .grid {
            display: grid;
            gap: 4px !important;
            grid-gap: 4px !important;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 0 auto;
            width: fit-content;
            height: fit-content;
            overflow: visible;
            box-sizing: border-box;
        }

        #player-grid.grid-4,
        #target-grid.grid-4 {
            grid-template-columns: repeat(4, 54px);
            grid-template-rows: repeat(4, 54px);
            min-width: 236px;
            min-height: 236px;
            max-width: 236px;
            max-height: 236px;
        }

        #player-grid,
        #target-grid {
            box-sizing: border-box;
        }

        #player-grid.grid-5,
        #target-grid.grid-5 {
            grid-template-columns: repeat(5, 43px);
            grid-template-rows: repeat(5, 43px);
            min-width: 239px;
            min-height: 239px;
            max-width: 239px;
            max-height: 239px;
        }

        #player-grid.grid-6,
        #target-grid.grid-6 {
            grid-template-columns: repeat(6, 35px);
            grid-template-rows: repeat(6, 35px);
            min-width: 238px;
            min-height: 238px;
            max-width: 238px;
            max-height: 238px;
        }

        .cell {
            background: #0ea5e9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: block;
            box-sizing: border-box;
        }

        button.cell {
            font-family: inherit;
            font-size: inherit;
            line-height: 1;
            padding: 0;
            margin: 0;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            text-align: center;
            vertical-align: middle;
        }

        .grid-4 .cell {
            width: 54px;
            height: 54px;
        }
        
        .grid-5 .cell {
            border-radius: 6px;
            width: 43px;
            height: 43px;
        }

        .grid-6 .cell {
            border-radius: 5px;
            width: 35px;
            height: 35px;
        }

        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 50%);
            opacity: 1;
            transition: opacity 0.2s;
        }

        .cell.dark {
            background: #2d2d2d;
            transform: scale(0.95);
        }

        .cell.dark::before {
            opacity: 0;
        }

        .cell:hover:not(.animating) {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
        }

        @media (hover: none) and (pointer: coarse) {
            .cell:hover {
                transform: none;
                box-shadow: none;
            }
        }

        .cell.preview-light {
            background: #38bdf8 !important;
        }

        .cell.preview-dark {
            background: #525252 !important;
        }

        .cell.animating {
            animation: flip 0.4s ease-in-out;
        }

        @keyframes flip {
            0% { transform: scale(1) rotateY(0); }
            50% { transform: scale(1.2) rotateY(90deg); }
            100% { transform: scale(1) rotateY(180deg); }
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(14, 165, 233, 0.3);
            transform: scale(0);
            animation: ripple-effect 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Overlay Styles */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 32px;
            color: #666;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .modal h2 {
            font-size: 26px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #1a1a1a;
        }

        .modal .subtitle {
            color: #666;
            font-size: 15px;
            margin: 0 0 20px 0;
            text-align: center;
        }

        .tutorial-section {
            margin: 20px 0;
            text-align: left;
        }

        .tutorial-section h3 {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 14px 0;
            color: #1a1a1a;
        }

        .example-grid {
            margin: 20px 0;
            text-align: center;
        }

        .example-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .example-item {
            flex: 1;
            min-width: 120px;
            max-width: 150px;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(3, 36px);
            grid-template-rows: repeat(3, 36px);
            gap: 3px;
            background: #f0f0f0;
            padding: 3px;
            border-radius: 8px;
            margin: 0 auto 10px;
            width: fit-content;
            height: fit-content;
        }

        .mini-cell {
            border-radius: 4px;
            transition: all 0.2s;
            width: 100%;
            height: 100%;
        }

        .mini-cell.light {
            background: #0ea5e9;
        }

        .mini-cell.dark {
            background: #2d2d2d;
        }

        .mini-cell.highlight {
            box-shadow: 0 0 0 2px #fbbf24;
        }

        .mini-cell.center-highlight {
            box-shadow: 0 0 0 3px #ef4444;
            transform: scale(1.1);
        }

        .example-text {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            margin: 0;
            text-align: center;
        }

        .example-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 8px;
            text-align: center;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 10px 0;
        }

        .rule-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            color: #666;
        }

        .rule-text {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .tutorial-footer {
            margin-top: 28px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
        }

        .play-btn {
            background: #0ea5e9;
            color: white;
            padding: 10px 38px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .play-btn:hover {
            background: #0284c7;
        }

        /* Result Modal */
        .result-modal {
            text-align: center;
            padding: 36px;
            max-width: 420px;
        }
        
        /* Solution Modal */
        .solution-modal {
            text-align: center;
            padding: 36px;
            max-width: 420px;
        }
        
        #solution-steps {
            margin-top: 24px;
        }
        
        .solution-step {
            margin: 20px 0;
        }
        
        .solution-grid {
            display: grid;
            gap: 4px;
            background: #f0f0f0;
            padding: 4px;
            border-radius: 12px;
            margin: 0 auto;
            width: fit-content;
        }
        
        .solution-grid.grid-4 {
            grid-template-columns: repeat(4, 40px);
            grid-template-rows: repeat(4, 40px);
        }
        
        .solution-grid.grid-5 {
            grid-template-columns: repeat(5, 32px);
            grid-template-rows: repeat(5, 32px);
        }
        
        .solution-grid.grid-6 {
            grid-template-columns: repeat(6, 27px);
            grid-template-rows: repeat(6, 27px);
        }
        
        .solution-cell {
            background: #0ea5e9;
            border-radius: 6px;
            position: relative;
            transition: all 0.2s;
        }
        
        .solution-grid.grid-5 .solution-cell {
            border-radius: 5px;
        }
        
        .solution-grid.grid-6 .solution-cell {
            border-radius: 4px;
        }
        
        .solution-cell.dark {
            background: #2d2d2d;
        }
        
        .solution-cell.clicked {
            box-shadow: 0 0 0 2px #ef4444;
            transform: scale(1.05);
            z-index: 1;
        }
        
        .solution-arrow {
            font-size: 24px;
            color: #666;
            margin: 16px 0;
        }

        .result-header {
            margin-bottom: 28px;
        }

        .result-strikes {
            display: inline-flex;
            gap: 12px;
            margin: 24px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 12px;
        }

        .result-strike {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
        }

        .result-strike.success {
            background: #4ade80;
            color: #000;
        }

        .result-strike.fail {
            background: #ef4444;
            color: white;
        }

        .result-strike.unused {
            background: #e0e0e0;
            color: #999;
        }

        .result-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            align-items: center;
            margin-top: 24px;
        }

        .result-btn {
            padding: 11px 28px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-btn {
            background: #0ea5e9;
            color: white;
        }

        .share-btn:hover {
            background: #0284c7;
        }

        .solution-btn {
            background: transparent;
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
            padding: 9px 26px;
        }

        .solution-btn:hover {
            background: rgba(14, 165, 233, 0.1);
            border-color: #0284c7;
            color: #0284c7;
        }

        .streak-stats {
            margin: 20px 0;
            padding: 16px;
            background: #f0f9ff;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .streak-item {
            text-align: center;
        }

        .streak-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }

        .streak-value {
            font-size: 24px;
            font-weight: 700;
            color: #0ea5e9;
        }

        #target-display {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
        }

        #target-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #666;
            margin-bottom: 12px;
        }

        #target-grid {
            transform: scale(0.6);
            opacity: 0.6;
            pointer-events: none;
            width: auto !important;
            height: auto !important;
        }

        #target-grid.grid-5 {
            transform: scale(0.65);
        }

        #target-grid.grid-6 {
            transform: scale(0.7);
        }

        #actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #strike-btn {
            background: #ef4444;
            color: white;
            width: 120px;
        }

        #strike-btn:hover:not(.disabled) {
            background: #dc2626;
        }

        #strike-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #strike-btn.disabled:hover {
            background: #ef4444;
            transform: none;
            box-shadow: none;
        }

        #share-btn {
            background: #0ea5e9;
            color: white;
            width: 120px;
        }

        #share-btn:hover:not(.disabled) {
            background: #0284c7;
        }

        #share-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #share-btn.disabled:hover {
            background: #0ea5e9;
            transform: none;
            box-shadow: none;
        }
        
        #solution-btn {
            background: transparent;
            color: #0ea5e9;
            border: 2px solid #0ea5e9;
            width: 120px;
            padding: 8px 18px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        #solution-btn:hover:not(.disabled) {
            background: rgba(14, 165, 233, 0.1);
            border-color: #0284c7;
            color: #0284c7;
        }
        
        #solution-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #solution-btn.disabled:hover {
            background: transparent;
            color: #0ea5e9;
            border-color: #0ea5e9;
        }

        #message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: #0ea5e9;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        #message.show {
            opacity: 1;
        }

        .particles {
            position: fixed;
            pointer-events: none;
            z-index: 100;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #0ea5e9;
            border-radius: 50%;
            animation: particle-float 1s ease-out forwards;
        }

        @keyframes particle-float {
            to {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .completed-indicator {
            display: inline-block;
            margin-left: 8px;
            padding: 4px 12px;
            background: #4ade80;
            color: #000;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .completed-indicator.failed {
            background: #ef4444;
            color: white;
        }

        @media (min-width: 501px) {
            .grid-4 .cell {
                width: 54px !important;
                height: 54px !important;
                min-width: 54px !important;
                min-height: 54px !important;
                max-width: 54px !important;
                max-height: 54px !important;
            }
            
            .grid-5 .cell {
                width: 43px !important;
                height: 43px !important;
                min-width: 43px !important;
                min-height: 43px !important;
                max-width: 43px !important;
                max-height: 43px !important;
            }
            
            .grid-6 .cell {
                width: 35px !important;
                height: 35px !important;
                min-width: 35px !important;
                min-height: 35px !important;
                max-width: 35px !important;
                max-height: 35px !important;
            }
        }

        @media (max-width: 500px) {
            body {
                padding: 10px;
                padding-bottom: env(safe-area-inset-bottom, 10px);
            }
            
            #game-container {
                padding: 20px 15px 25px;
                max-height: none;
                height: auto;
            }
            
            h1 {
                font-size: 32px;
            }

            .grid {
                display: grid !important;
                gap: 4px !important;
                grid-gap: 4px !important;
                margin: 0 auto !important;
                padding: 4px !important;
                background: #f0f0f0 !important;
                border-radius: 12px !important;
                width: fit-content !important;
                height: fit-content !important;
                box-sizing: border-box !important;
            }

            #player-grid.grid-4,
            #target-grid.grid-4 {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important;
                grid-template-rows: repeat(4, 1fr) !important;
                gap: 4px !important;
                grid-gap: 4px !important;
                width: 216px !important;
                height: 216px !important;
            }
            
            .grid-4 .cell {
                width: 100% !important;
                height: 100% !important;
                border-radius: 8px !important;
                transform: none !important;
            }

            .grid-4 .cell.dark {
                transform: none !important;
            }

            #player-grid.grid-5,
            #target-grid.grid-5 {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr) !important;
                grid-template-rows: repeat(5, 1fr) !important;
                gap: 4px !important;
                grid-gap: 4px !important;
                width: 214px !important;
                height: 214px !important;
            }
            
            .grid-5 .cell {
                width: 100% !important;
                height: 100% !important;
                border-radius: 6px !important;
                transform: none !important;
            }

            .grid-5 .cell.dark {
                transform: none !important;
            }

            #player-grid.grid-6,
            #target-grid.grid-6 {
                display: grid !important;
                grid-template-columns: repeat(6, 1fr) !important;
                grid-template-rows: repeat(6, 1fr) !important;
                gap: 4px !important;
                grid-gap: 4px !important;
                width: 214px !important;
                height: 214px !important;
            }
            
            .grid-6 .cell {
                width: 100% !important;
                height: 100% !important;
                border-radius: 5px !important;
                transform: none !important;
            }

            .grid-6 .cell.dark {
                transform: none !important;
            }

            .modal {
                padding: 20px;
                max-width: 95%;
                max-height: 85vh;
            }
            
            .help-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }

            #stats {
                gap: 20px;
            }

            .result-actions {
                flex-direction: column;
            }

            .result-btn {
                width: 100% !important;
            }

            .example-row {
                flex-direction: row;
                gap: 10px;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .example-item {
                flex: 0 0 auto;
                min-width: auto;
                max-width: none;
                width: 90px;
            }
            
            .mini-grid {
                grid-template-columns: repeat(3, 24px);
                grid-template-rows: repeat(3, 24px);
                gap: 2px;
                padding: 2px;
                margin: 0 auto 6px;
            }
            
            .mini-cell.center-highlight {
                box-shadow: 0 0 0 2px #ef4444;
            }
            
            .mini-cell.highlight {
                box-shadow: 0 0 0 1px #fbbf24;
            }
            
            .example-label {
                font-size: 10px;
                margin-bottom: 4px;
            }
            
            .example-item .example-text {
                font-size: 11px;
            }
            
            #actions {
                flex-direction: column;
            }
            
            #strike-btn,
            #share-btn,
            #solution-btn {
                width: 100%;
            }

            .streak-stats {
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <header>
            <h1>FLUX</h1>
            <div id="subtitle">Daily Puzzle #<span id="puzzle-number"></span></div>
            <button class="help-btn" onclick="Game.showTutorial()" title="How to play">?</button>
            <div id="mode-toggle">
                <button class="mode-btn active" onclick="Game.setMode(4)">4×4</button>
                <button class="mode-btn" onclick="Game.setMode(5)">5×5</button>
                <button class="mode-btn" onclick="Game.setMode(6)">6×6</button>
            </div>
        </header>

        <div id="stats">
            <div class="stat">
                Moves Left: <span class="stat-value" id="moves-left">0</span>
            </div>
            <div class="stat">
                Strikes: <div id="strikes-display">
                    <div class="strike" id="strike-1">✗</div>
                    <div class="strike" id="strike-2">✗</div>
                    <div class="strike" id="strike-3">✗</div>
                </div>
            </div>
        </div>

        <div id="game-area">
            <div id="player-grid" class="grid grid-4"></div>
        </div>

        <div id="target-display">
            <div id="target-label">Target Pattern</div>
            <div id="target-grid" class="grid grid-4"></div>
        </div>

        <div id="actions">
            <button id="strike-btn" onclick="Game.takeStrike()">Strike</button>
            <button id="solution-btn" class="disabled" onclick="Game.showSolution()">Solution</button>
            <button id="share-btn" class="disabled" onclick="Game.shareResults()">Share</button>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="overlay">
        <div class="modal">
            <button class="close-btn" onclick="Game.closeTutorial()">&times;</button>
            <h2>How To Play</h2>
            <p class="subtitle">Solve the puzzle in the exact number of moves.</p>
            
            <div class="tutorial-section">
                <h3>The Rules</h3>
                
                <p class="example-text" style="text-align: left; margin: 0 0 20px 0;">Click a tile to flip it and its adjacent neighbors. The pattern varies depending on the tile's position - a plus pattern in the center, T pattern on edges, and L pattern in corners.</p>
                
                <div class="example-row">
                    <div class="example-item">
                        <div class="example-label">Center</div>
                        <div class="mini-grid">
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell dark center-highlight"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                        </div>
                        <p class="example-text">Plus pattern</p>
                    </div>
                    
                    <div class="example-item">
                        <div class="example-label">Edge</div>
                        <div class="mini-grid">
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark center-highlight"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                        </div>
                        <p class="example-text">T pattern</p>
                    </div>
                    
                    <div class="example-item">
                        <div class="example-label">Corner</div>
                        <div class="mini-grid">
                            <div class="mini-cell dark center-highlight"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell dark highlight"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                            <div class="mini-cell light"></div>
                        </div>
                        <p class="example-text">L pattern</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <div class="rule-item">
                        <div class="rule-icon">•</div>
                        <div class="rule-text">You get the <strong>exact number of moves</strong> needed to solve</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">×</div>
                        <div class="rule-text">Fail = Strike (3 strikes = game over)</div>
                    </div>
                    <div class="rule-item">
                        <div class="rule-icon">↻</div>
                        <div class="rule-text">Each strike resets the board</div>
                    </div>
                </div>
            </div>
            
            <div class="tutorial-footer">
                <button class="play-btn" onclick="Game.closeTutorial()">Play</button>
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-overlay" class="overlay">
        <div class="modal result-modal">
            <button class="close-btn" onclick="Game.closeResult()">&times;</button>
            <div class="result-header">
                <h2 id="result-title">Nice Try!</h2>
                <p class="subtitle" id="result-subtitle">You'll get it tomorrow!</p>
            </div>
            
            <div class="result-strikes" id="result-strikes">
                <div class="result-strike fail">✗</div>
                <div class="result-strike fail">✗</div>
                <div class="result-strike fail">✗</div>
            </div>
            
            <div class="streak-stats" id="streak-stats">
                <div class="streak-item">
                    <div class="streak-label">Current Streak</div>
                    <div class="streak-value" id="current-streak">0</div>
                </div>
                <div class="streak-item">
                    <div class="streak-label">Best Streak</div>
                    <div class="streak-value" id="best-streak">0</div>
                </div>
            </div>
            
            <div class="result-actions" id="result-actions">
                <button class="result-btn share-btn" onclick="Game.shareResults()">Share</button>
                <button class="result-btn solution-btn" onclick="Game.showSolution()">Solution</button>
            </div>
        </div>
    </div>
    
    <!-- Solution Overlay -->
    <div id="solution-overlay" class="overlay">
        <div class="modal solution-modal">
            <button class="close-btn" onclick="Game.closeSolution()">&times;</button>
            <h2>Solution</h2>
            <p class="subtitle">Here's how to solve today's puzzle:</p>
            <div id="solution-steps"></div>
        </div>
    </div>

    <div id="message"></div>
    <div class="particles" id="particles"></div>

    <script>
        // Game namespace to avoid global pollution
        const Game = {
            // State
            gridSize: 4,
            playerGrid: [],
            targetGrid: [],
            solutionMoves: [],
            strikes: 0,
            movesLeft: 0,
            optimalMoves: 0,
            isAnimating: false,
            gameComplete: false,
            
            // Memory storage fallback
            memoryStorage: {},
            
            // Elements
            elements: {
                playerGrid: document.getElementById('player-grid'),
                targetGrid: document.getElementById('target-grid'),
                movesLeft: document.getElementById('moves-left'),
                strikeBtn: document.getElementById('strike-btn'),
                shareBtn: document.getElementById('share-btn'),
                solutionBtn: document.getElementById('solution-btn'),
                message: document.getElementById('message'),
                tutorialOverlay: document.getElementById('tutorial-overlay'),
                resultOverlay: document.getElementById('result-overlay'),
                solutionOverlay: document.getElementById('solution-overlay'),
                puzzleNumber: document.getElementById('puzzle-number'),
                strikes: [
                    document.getElementById('strike-1'),
                    document.getElementById('strike-2'),
                    document.getElementById('strike-3')
                ]
            },
            
            // Storage helpers
            isLocalStorageAvailable() {
                try {
                    const test = '__flux_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            },
            
            safeSetItem(key, value) {
                if (this.isLocalStorageAvailable()) {
                    localStorage.setItem(key, value);
                } else {
                    this.memoryStorage[key] = value;
                }
            },
            
            safeGetItem(key) {
                if (this.isLocalStorageAvailable()) {
                    return localStorage.getItem(key);
                } else {
                    return this.memoryStorage[key] || null;
                }
            },
            
            // Get today's date info
            getDateInfo() {
                const today = new Date();
                const startDate = new Date('2025-07-29');
                
                // Calculate based on local dates, not UTC time
                const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const startLocal = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
                
                const dayNumber = Math.floor((todayLocal - startLocal) / (1000 * 60 * 60 * 24)) + 1;
                return { today, dayNumber };
            },
            
            // Get save key for today's puzzle
            getTodaysSaveKey() {
                const { dayNumber } = this.getDateInfo();
                return `flux-puzzle-${dayNumber}-${this.gridSize}`;
            },
            
            // Streak management
            getCurrentStreak(size) {
                const streakValue = this.safeGetItem(`flux-streak-${size}`);
                return streakValue ? parseInt(streakValue) : 0;
            },
            
            getMaxStreak(size) {
                const maxValue = this.safeGetItem(`flux-max-streak-${size}`);
                return maxValue ? parseInt(maxValue) : 0;
            },
            
            incrementStreak(size) {
                const currentStreak = this.getCurrentStreak(size) + 1;
                const maxStreak = this.getMaxStreak(size);
                
                this.safeSetItem(`flux-streak-${size}`, currentStreak.toString());
                
                if (currentStreak > maxStreak) {
                    this.safeSetItem(`flux-max-streak-${size}`, currentStreak.toString());
                }
            },
            
            resetStreak(size) {
                this.safeSetItem(`flux-streak-${size}`, '0');
            },
            
            // Save current game state
            saveCurrentState() {
                const data = {
                    complete: this.gameComplete,
                    won: this.checkWin(),
                    strikes: this.strikes,
                    movesLeft: this.movesLeft,
                    playerGrid: [...this.playerGrid],
                    optimalMoves: this.optimalMoves,
                    date: new Date().toISOString()
                };
                
                this.safeSetItem(this.getTodaysSaveKey(), JSON.stringify(data));
            },
            
            // Initialize game
            init() {
                const { dayNumber } = this.getDateInfo();
                this.elements.puzzleNumber.textContent = dayNumber.toString().padStart(3, '0');
                
                // Check if first time player
                const hasPlayed = this.safeGetItem('flux-has-played');
                if (!hasPlayed) {
                    setTimeout(() => this.showTutorial(), 500);
                }
                
                this.loadOrStartGame();
                this.updateModeButtons();
            },
            
            // Load saved game or start new
            loadOrStartGame() {
                const saved = this.safeGetItem(this.getTodaysSaveKey());
                
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // Generate the puzzle first to get targets
                    const puzzle = this.generatePuzzle(this.gridSize);
                    this.targetGrid = puzzle.target;
                    this.optimalMoves = puzzle.moves;
                    this.solutionMoves = puzzle.solutionMoves;
                    
                    if (data.complete) {
                        // Show completed state
                        this.strikes = data.strikes;
                        this.gameComplete = true;
                        this.movesLeft = 0;
                        this.playerGrid = data.won ? [...this.targetGrid] : Array(this.gridSize * this.gridSize).fill(true);
                        
                        this.renderGame();
                        this.updateStrikesDisplay();
                        this.disableGameplay();
                        
                        // Enable share and solution buttons for completed games
                        this.elements.shareBtn.classList.remove('disabled');
                        this.elements.solutionBtn.classList.remove('disabled');
                        
                        const statsDiv = document.getElementById('stats');
                        const indicator = document.createElement('span');
                        indicator.className = 'completed-indicator';
                        if (data.won) {
                            indicator.textContent = 'Completed';
                        } else {
                            indicator.textContent = 'Failed';
                            indicator.classList.add('failed');
                        }
                        statsDiv.appendChild(indicator);
                    } else {
                        // Resume in-progress game
                        this.strikes = data.strikes;
                        this.movesLeft = data.movesLeft;
                        this.playerGrid = [...data.playerGrid];
                        this.gameComplete = false;
                        this.isAnimating = false;
                        
                        this.renderGame();
                        this.updateStrikesDisplay();
                    }
                    
                    return;
                }
                
                // Start new game
                this.startNewGame();
            },
            
            // Start new game
            startNewGame() {
                this.strikes = 0;
                this.gameComplete = false;
                this.isAnimating = false;
                
                // Ensure buttons are in correct state for new games
                this.elements.shareBtn.classList.add('disabled');
                this.elements.solutionBtn.classList.add('disabled');
                this.elements.strikeBtn.classList.remove('disabled');
                
                const puzzle = this.generatePuzzle(this.gridSize);
                this.playerGrid = puzzle.start;
                this.targetGrid = puzzle.target;
                this.optimalMoves = puzzle.moves;
                this.solutionMoves = puzzle.solutionMoves;
                this.movesLeft = puzzle.moves;
                
                this.renderGame();
                this.updateStrikesDisplay();
                
                // Save initial state
                this.saveCurrentState();
            },
            
            // Generate puzzle
            generatePuzzle(size) {
                const { dayNumber } = this.getDateInfo();
                const seed = (dayNumber - 1) * 100 + size;
                let rng = seed;
                
                // Start with all light
                const grid = Array(size * size).fill(true);
                
                // Fixed moves based on size
                let moves;
                if (size === 4) moves = 3;
                else if (size === 5) moves = 5;
                else if (size === 6) moves = 7;
                
                const movesToMake = [];
                
                // Generate unique random positions
                while (movesToMake.length < moves) {
                    rng = (rng * 1103515245 + 12345) & 0x7fffffff;
                    const pos = rng % (size * size);
                    if (!movesToMake.includes(pos)) {
                        movesToMake.push(pos);
                    }
                }
                
                // Apply moves to create target
                movesToMake.forEach(index => {
                    this.toggleCellPattern(grid, index, size);
                });
                
                return {
                    start: Array(size * size).fill(true),
                    target: grid,
                    moves: moves,
                    solutionMoves: movesToMake
                };
            },
            
            // Toggle cell pattern
            toggleCellPattern(grid, index, size) {
                grid[index] = !grid[index];
                
                const row = Math.floor(index / size);
                const col = index % size;
                
                if (row > 0) grid[index - size] = !grid[index - size];
                if (row < size - 1) grid[index + size] = !grid[index + size];
                if (col > 0) grid[index - 1] = !grid[index - 1];
                if (col < size - 1) grid[index + 1] = !grid[index + 1];
            },
            
            // Render game
            renderGame() {
                // Update moves display
                this.elements.movesLeft.textContent = this.movesLeft;
                
                // Render grids
                this.elements.playerGrid.innerHTML = '';
                this.elements.targetGrid.innerHTML = '';
                
                for (let i = 0; i < this.gridSize * this.gridSize; i++) {
                    // Player grid
                    const playerCell = document.createElement('button');
                    playerCell.className = 'cell' + (this.playerGrid[i] ? '' : ' dark');
                    playerCell.setAttribute('type', 'button');
                    playerCell.onclick = () => this.clickCell(i);
                    
                    if (window.matchMedia('(hover: hover)').matches) {
                        playerCell.onmouseenter = () => this.showPreview(i);
                        playerCell.onmouseleave = () => this.hidePreview();
                    }
                    
                    this.elements.playerGrid.appendChild(playerCell);
                    
                    // Target grid
                    const targetCell = document.createElement('div');
                    targetCell.className = 'cell' + (this.targetGrid[i] ? '' : ' dark');
                    this.elements.targetGrid.appendChild(targetCell);
                }
                
                // Update button state
                this.updateStrikeButton();
            },
            
            // Click cell
            clickCell(index) {
                if (this.gameComplete || this.isAnimating || this.movesLeft === 0) return;
                
                this.isAnimating = true;
                this.movesLeft--;
                this.elements.movesLeft.textContent = this.movesLeft;
                
                // Hide preview
                this.hidePreview();
                
                // Create ripple
                const cell = this.elements.playerGrid.children[index];
                const rect = cell.getBoundingClientRect();
                this.createRipple(rect.left + rect.width / 2, rect.top + rect.height / 2);
                
                // Get cells to flip
                const cellsToFlip = this.getCellsToFlip(index);
                
                // Animate flips
                cellsToFlip.forEach((i, delay) => {
                    setTimeout(() => {
                        const cell = this.elements.playerGrid.children[i];
                        cell.classList.add('animating');
                        
                        setTimeout(() => {
                            this.playerGrid[i] = !this.playerGrid[i];
                            cell.classList.toggle('dark');
                            cell.classList.remove('animating');
                            
                            // Check result after last animation
                            if (delay === cellsToFlip.length - 1) {
                                setTimeout(() => {
                                    this.isAnimating = false;
                                    // Save state after move completes
                                    this.saveCurrentState();
                                    this.checkGameState();
                                }, 100);
                            }
                        }, 200);
                    }, delay * 50);
                });
            },
            
            // Get cells to flip
            getCellsToFlip(index) {
                const cells = [index];
                const row = Math.floor(index / this.gridSize);
                const col = index % this.gridSize;
                
                if (row > 0) cells.push(index - this.gridSize);
                if (row < this.gridSize - 1) cells.push(index + this.gridSize);
                if (col > 0) cells.push(index - 1);
                if (col < this.gridSize - 1) cells.push(index + 1);
                
                return cells;
            },
            
            // Check game state
            checkGameState() {
                const won = this.checkWin();
                
                if (won) {
                    this.handleWin();
                } else if (this.movesLeft === 0) {
                    // Delay slightly to let animations finish
                    setTimeout(() => {
                        this.handleStrike();
                    }, 300);
                }
                
                this.updateStrikeButton();
            },
            
            // Check win
            checkWin() {
                return this.playerGrid.every((cell, i) => cell === this.targetGrid[i]);
            },
            
            // Handle win
            handleWin() {
                this.gameComplete = true;
                this.incrementStreak(this.gridSize);
                this.saveGameState(true);
                this.elements.shareBtn.classList.remove('disabled');
                this.elements.solutionBtn.classList.remove('disabled');
                this.elements.strikeBtn.classList.add('disabled');
                this.showResult(true);
                this.createCelebration();
            },
            
            // Handle strike
            handleStrike() {
                // Prevent multiple strikes while animating
                if (this.isAnimating) return;
                
                this.strikes++;
                this.updateStrikesDisplay();
                
                if (this.strikes >= 3) {
                    // Game over
                    this.gameComplete = true;
                    this.resetStreak(this.gridSize);
                    this.saveGameState(false);
                    this.elements.shareBtn.classList.remove('disabled');
                    this.elements.solutionBtn.classList.remove('disabled');
                    this.elements.strikeBtn.classList.add('disabled');
                    this.showResult(false);
                } else {
                    // Reset for next attempt
                    this.showMessage(`Strike ${this.strikes}! ${3 - this.strikes} ${this.strikes === 2 ? 'chance' : 'chances'} left`);
                    this.isAnimating = true;
                    // Save state after strike
                    this.saveCurrentState();
                    setTimeout(() => {
                        this.resetBoard();
                    }, 1500);
                }
            },
            
            // Take strike manually
            takeStrike() {
                // Don't allow if game is complete or animating
                if (this.gameComplete || this.isAnimating) return;
                
                // Don't allow if button is disabled
                if (this.elements.strikeBtn.classList.contains('disabled')) return;
                
                // Only allow if we have moves left
                if (this.movesLeft > 0) {
                    this.movesLeft = 0;
                    this.handleStrike();
                }
            },
            
            // Reset board for next attempt
            resetBoard() {
                this.playerGrid = Array(this.gridSize * this.gridSize).fill(true);
                this.movesLeft = this.optimalMoves;
                this.isAnimating = false;
                this.renderGame();
                // Save state after board reset
                this.saveCurrentState();
            },
            
            // Update strikes display
            updateStrikesDisplay() {
                this.elements.strikes.forEach((el, i) => {
                    if (i < this.strikes) {
                        el.classList.add('filled');
                        el.classList.remove('success');
                        el.textContent = '✗';
                    } else if (i === this.strikes && this.gameComplete && this.checkWin()) {
                        el.classList.add('success');
                        el.classList.remove('filled');
                        el.textContent = '✓';
                    } else {
                        el.classList.remove('filled', 'success');
                        el.textContent = '✗';
                    }
                });
            },
            
            // Update strike button
            updateStrikeButton() {
                if (this.movesLeft === 0 || this.gameComplete) {
                    this.elements.strikeBtn.classList.add('disabled');
                } else {
                    this.elements.strikeBtn.classList.remove('disabled');
                }
            },
            
            // Save game state (for completed games)
            saveGameState(won) {
                const data = {
                    complete: true,
                    won: won,
                    strikes: this.strikes,
                    optimalMoves: this.optimalMoves,
                    date: new Date().toISOString()
                };
                
                this.safeSetItem(this.getTodaysSaveKey(), JSON.stringify(data));
                this.updateModeButtons();
            },
            
            // Show result modal
            showResult(won) {
                const modal = this.elements.resultOverlay;
                const title = document.getElementById('result-title');
                const subtitle = document.getElementById('result-subtitle');
                const strikesContainer = document.getElementById('result-strikes');
                const resultActions = document.getElementById('result-actions');
                
                // Update streak stats
                const currentStreak = this.getCurrentStreak(this.gridSize);
                const bestStreak = this.getMaxStreak(this.gridSize);
                document.getElementById('current-streak').textContent = currentStreak;
                document.getElementById('best-streak').textContent = bestStreak;
                
                if (won) {
                    title.textContent = 'Perfect!';
                    
                    // Convert attempts to ordinal
                    const attempts = this.strikes + 1;
                    let ordinal;
                    if (attempts === 1) ordinal = 'first';
                    else if (attempts === 2) ordinal = 'second';
                    else if (attempts === 3) ordinal = 'third';
                    
                    subtitle.textContent = `Solved in ${ordinal} attempt.`;
                    
                    // Show strikes
                    strikesContainer.innerHTML = '';
                    for (let i = 0; i < 3; i++) {
                        const strike = document.createElement('div');
                        strike.className = 'result-strike';
                        
                        if (i < this.strikes) {
                            strike.className += ' fail';
                            strike.textContent = '✗';
                        } else if (i === this.strikes) {
                            strike.className += ' success';
                            strike.textContent = '✓';
                        } else {
                            strike.className += ' unused';
                            strike.textContent = '○';
                        }
                        
                        strikesContainer.appendChild(strike);
                    }
                    
                    // For wins, only show Share button
                    resultActions.innerHTML = '<button class="result-btn share-btn" onclick="Game.shareResults()">Share</button>';
                } else {
                    title.textContent = 'Nice Try!';
                    subtitle.textContent = 'Better luck tomorrow!';
                    
                    // All strikes failed
                    strikesContainer.innerHTML = '';
                    for (let i = 0; i < 3; i++) {
                        const strike = document.createElement('div');
                        strike.className = 'result-strike fail';
                        strike.textContent = '✗';
                        strikesContainer.appendChild(strike);
                    }
                    
                    // For losses, show Solution (left) and Share (right)
                    resultActions.innerHTML = '<button class="result-btn solution-btn" onclick="Game.showSolution()">Solution</button><button class="result-btn share-btn" onclick="Game.shareResults()">Share</button>';
                }
                
                modal.classList.add('show');
            },
            
            // Share results
            shareResults() {
                // Don't allow sharing if button is disabled
                if (this.elements.shareBtn && this.elements.shareBtn.classList.contains('disabled')) return;
                
                const { dayNumber } = this.getDateInfo();
                let modeText = '';
                if (this.gridSize === 5) modeText = ' (5×5)';
                else if (this.gridSize === 6) modeText = ' (6×6)';
                
                let strikesText = '';
                for (let i = 0; i < 3; i++) {
                    if (i < this.strikes) {
                        strikesText += '❌';
                    } else if (i === this.strikes && this.gameComplete && this.checkWin()) {
                        strikesText += '✅';
                    } else {
                        strikesText += '⚪';
                    }
                }
                
                const text = `FLUX ${dayNumber.toString().padStart(3, '0')}${modeText}\n${strikesText}\n\nflux-game.com`;
                
                navigator.clipboard.writeText(text).then(() => {
                    this.showMessage('Copied to clipboard!');
                }).catch(() => {
                    this.showMessage('Failed to copy');
                });
            },
            
            // Show solution
            showSolution() {
                // Don't allow if button is disabled
                if (this.elements.solutionBtn && this.elements.solutionBtn.classList.contains('disabled')) return;
                
                this.elements.resultOverlay.classList.remove('show');
                
                const stepsContainer = document.getElementById('solution-steps');
                stepsContainer.innerHTML = '';
                
                // Start with all light grid
                let currentGrid = Array(this.gridSize * this.gridSize).fill(true);
                
                // Show starting grid
                const startStep = document.createElement('div');
                startStep.className = 'solution-step';
                startStep.appendChild(this.createSolutionGrid(currentGrid, -1));
                stepsContainer.appendChild(startStep);
                
                // Show each move
                this.solutionMoves.forEach((moveIndex, stepNum) => {
                    // Add arrow
                    const arrow = document.createElement('div');
                    arrow.className = 'solution-arrow';
                    arrow.textContent = '↓';
                    stepsContainer.appendChild(arrow);
                    
                    // Apply the move
                    this.toggleCellPattern(currentGrid, moveIndex, this.gridSize);
                    
                    // Show grid with clicked cell highlighted
                    const step = document.createElement('div');
                    step.className = 'solution-step';
                    step.appendChild(this.createSolutionGrid(currentGrid, moveIndex));
                    stepsContainer.appendChild(step);
                });
                
                this.elements.solutionOverlay.classList.add('show');
            },
            
            // Create solution grid display
            createSolutionGrid(gridState, clickedIndex) {
                const grid = document.createElement('div');
                grid.className = `solution-grid grid-${this.gridSize}`;
                
                gridState.forEach((cell, index) => {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'solution-cell' + (cell ? '' : ' dark');
                    if (index === clickedIndex) {
                        cellDiv.classList.add('clicked');
                    }
                    grid.appendChild(cellDiv);
                });
                
                return grid;
            },
            
            // Close solution
            closeSolution() {
                this.elements.solutionOverlay.classList.remove('show');
            },
            
            // Preview hover
            showPreview(index) {
                if (this.gameComplete || this.isAnimating || this.movesLeft === 0) return;
                
                const cellsToFlip = this.getCellsToFlip(index);
                cellsToFlip.forEach(i => {
                    const cell = this.elements.playerGrid.children[i];
                    if (this.playerGrid[i]) {
                        cell.classList.add('preview-dark');
                    } else {
                        cell.classList.add('preview-light');
                    }
                });
            },
            
            hidePreview() {
                const cells = this.elements.playerGrid.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.classList.remove('preview-dark', 'preview-light');
                });
            },
            
            // UI helpers
            showMessage(text) {
                this.elements.message.textContent = text;
                this.elements.message.classList.add('show');
                setTimeout(() => this.elements.message.classList.remove('show'), 2500);
            },
            
            createRipple(x, y) {
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                ripple.style.width = '20px';
                ripple.style.height = '20px';
                ripple.style.left = (x - 10) + 'px';
                ripple.style.top = (y - 10) + 'px';
                document.body.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            },
            
            createCelebration() {
                for (let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = window.innerHeight / 2;
                        this.createParticles(x, y, 10);
                    }, i * 200);
                }
            },
            
            createParticles(x, y, count) {
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = x + (Math.random() - 0.5) * 40 + 'px';
                        particle.style.top = y + (Math.random() - 0.5) * 40 + 'px';
                        document.getElementById('particles').appendChild(particle);
                        setTimeout(() => particle.remove(), 1000);
                    }, i * 50);
                }
            },
            
            // Tutorial
            showTutorial() {
                this.elements.tutorialOverlay.classList.add('show');
            },
            
            closeTutorial() {
                this.elements.tutorialOverlay.classList.remove('show');
                this.safeSetItem('flux-has-played', 'true');
            },
            
            // Result modal
            closeResult() {
                this.elements.resultOverlay.classList.remove('show');
            },
            
            // Mode switching
            setMode(size) {
                if (this.gridSize === size) return;
                
                this.gridSize = size;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach((btn, index) => {
                    btn.classList.toggle('active', 
                        (size === 4 && index === 0) || 
                        (size === 5 && index === 1) || 
                        (size === 6 && index === 2)
                    );
                });
                
                // Update grid classes - remove only size-specific classes
                this.elements.playerGrid.classList.remove('grid-4', 'grid-5', 'grid-6');
                this.elements.targetGrid.classList.remove('grid-4', 'grid-5', 'grid-6');
                
                // Force layout recalculation
                void this.elements.playerGrid.offsetHeight;
                void this.elements.targetGrid.offsetHeight;
                
                // Add new size class
                this.elements.playerGrid.classList.add(`grid-${size}`);
                this.elements.targetGrid.classList.add(`grid-${size}`);
                
                // Clear any existing completed indicator
                const indicator = document.querySelector('.completed-indicator');
                if (indicator) indicator.remove();
                
                // Reset buttons to default state when switching modes
                this.elements.shareBtn.classList.add('disabled');
                this.elements.solutionBtn.classList.add('disabled');
                this.elements.strikeBtn.classList.remove('disabled');
                
                // Load new game
                this.loadOrStartGame();
            },
            
            // Update mode buttons
            updateModeButtons() {
                const { dayNumber } = this.getDateInfo();
                const modeBtns = document.querySelectorAll('.mode-btn');
                
                // Check 4x4 completion
                const saved4x4 = this.safeGetItem(`flux-puzzle-${dayNumber}-4`);
                if (saved4x4) {
                    const data = JSON.parse(saved4x4);
                    if (data.complete) {
                        if (data.won) {
                            modeBtns[0].classList.add('completed');
                            modeBtns[0].classList.remove('failed');
                        } else {
                            modeBtns[0].classList.add('failed');
                            modeBtns[0].classList.remove('completed');
                        }
                    }
                }
                
                // Check 5x5 completion
                const saved5x5 = this.safeGetItem(`flux-puzzle-${dayNumber}-5`);
                if (saved5x5) {
                    const data = JSON.parse(saved5x5);
                    if (data.complete) {
                        if (data.won) {
                            modeBtns[1].classList.add('completed');
                            modeBtns[1].classList.remove('failed');
                        } else {
                            modeBtns[1].classList.add('failed');
                            modeBtns[1].classList.remove('completed');
                        }
                    }
                }
                
                // Check 6x6 completion
                const saved6x6 = this.safeGetItem(`flux-puzzle-${dayNumber}-6`);
                if (saved6x6) {
                    const data = JSON.parse(saved6x6);
                    if (data.complete) {
                        if (data.won) {
                            modeBtns[2].classList.add('completed');
                            modeBtns[2].classList.remove('failed');
                        } else {
                            modeBtns[2].classList.add('failed');
                            modeBtns[2].classList.remove('completed');
                        }
                    }
                }
            },
            
            // Disable gameplay
            disableGameplay() {
                const cells = this.elements.playerGrid.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.style.cursor = 'default';
                    cell.onclick = null;
                    cell.onmouseenter = null;
                    cell.onmouseleave = null;
                });
                
                this.elements.strikeBtn.classList.add('disabled');
            }
        };
        
        // Initialize game when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            Game.init();
        });
    </script>
</body>
</html>
